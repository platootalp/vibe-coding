# 测试说明

本文档详细说明了Fitness Tracker项目的测试策略、工具和执行方法。

## 测试策略

Fitness Tracker采用分层测试策略，确保应用的各个层面都得到充分测试：

1. **单元测试** - 测试独立的函数和组件
2. **集成测试** - 测试模块间的交互
3. **API测试** - 测试后端接口功能
4. **端到端测试** - 测试完整的用户场景

## 测试工具链

### 前端测试工具
- **Jest**: JavaScript测试框架
- **React Testing Library**: React组件测试库
- **Cypress**: 端到端测试工具
- **@testing-library/jest-dom**: DOM断言库

### 后端测试工具
- **Jest**: JavaScript测试框架
- **Supertest**: HTTP断言库
- **sqlite3-memory**: 内存数据库用于测试

## 测试环境配置

### 环境变量
```
# 测试环境变量
NODE_ENV=test
PORT=3002
JWT_SECRET=test_secret_key
MYSQL_HOST=localhost
MYSQL_USER=test_user
MYSQL_PASSWORD=test_password
MYSQL_DATABASE=fitnessTracker_test
```

### 数据库设置
- 使用独立的测试数据库
- 每次测试前重置数据库状态
- 使用工厂模式生成测试数据

## 测试文件组织

### 前端测试结构
```
frontend/
├── src/
│   ├── components/
│   │   ├── Navbar.tsx
│   │   └── Navbar.test.tsx
│   ├── pages/
│   │   ├── Login.tsx
│   │   └── Login.test.tsx
│   └── services/
│       ├── api.ts
│       └── api.test.ts
└── cypress/
    ├── integration/
    └── support/
```

### 后端测试结构
```
backend/
├── src/
│   ├── controllers/
│   │   ├── authController.ts
│   │   └── authController.test.ts
│   ├── models/
│   │   ├── User.ts
│   │   └── User.test.ts
│   └── routes/
│       ├── authRoutes.ts
│       └── authRoutes.test.ts
└── test/
    ├── setup.ts
    └── teardown.ts
```

## 测试执行

### 前端测试命令
```bash
# 进入前端目录
cd frontend

# 运行前端单元测试
npm run test

# 运行前端单元测试并生成覆盖率报告
npm run test:coverage

# 运行端到端测试
npm run test:e2e
```

### 后端测试命令
```bash
# 进入后端目录
cd backend

# 运行后端测试
npm run test

# 运行后端测试并生成覆盖率报告
npm run test:coverage
```

## 测试最佳实践

### 1. 测试命名规范
- 使用描述性的测试名称
- 遵循"should do something"的命名模式
- 保持测试名称简洁明了

### 2. 测试数据管理
- 使用工厂函数生成测试数据
- 避免硬编码测试数据
- 确保测试数据的独立性

### 3. 异步测试处理
- 正确处理Promise和async/await
- 使用适当的超时设置
- 确保异步操作完成后再进行断言

### 4. 测试隔离
- 每个测试应独立运行
- 避免测试间的依赖关系
- 使用beforeEach/afterEach清理测试环境

## 测试覆盖目标

### 代码覆盖率要求
- 前端组件测试：≥ 75%
- 前端集成测试：≥ 60%
- 前端E2E测试：≥ 40%
- 后端API测试：≥ 85%
- 后端数据库测试：≥ 90%

### 关键路径覆盖
- 用户注册和登录流程
- 运动记录创建和编辑流程
- 数据统计和图表展示
- 权限验证和错误处理

## 单元测试示例

### 前端组件测试
```typescript
import { render, screen } from '@testing-library/react';
import Navbar from './Navbar';

test('renders navigation links', () => {
  render(<Navbar />);
  
  expect(screen.getByText('首页')).toBeInTheDocument();
  expect(screen.getByText('登录')).toBeInTheDocument();
  expect(screen.getByText('注册')).toBeInTheDocument();
});
```

### 后端模型测试
```typescript
import User from '../models/User';

describe('User Model', () => {
  test('should create a user', async () => {
    const user = await User.create({
      name: 'Test User',
      email: 'test@example.com',
      password: 'password123'
    });
    
    expect(user.name).toBe('Test User');
    expect(user.email).toBe('test@example.com');
  });
});
```

## API测试示例

```typescript
import request from 'supertest';
import app from '../src/server';

describe('Auth API', () => {
  test('should register a new user', async () => {
    const response = await request(app)
      .post('/api/auth/register')
      .send({
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      });
      
    expect(response.status).toBe(201);
    expect(response.body).toHaveProperty('token');
  });
});
```

## 端到端测试示例

```typescript
describe('Login Flow', () => {
  it('should login successfully', () => {
    cy.visit('/login');
    
    cy.get('[data-testid="email-input"]').type('test@example.com');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="login-button"]').click();
    
    cy.url().should('include', '/dashboard');
    cy.contains('欢迎回来');
  });
});
```

## 持续集成

### CI/CD集成
- 在每次代码提交时自动运行测试
- 阻止测试失败的代码合并
- 生成测试报告并发送通知

### 测试报告
- 生成详细的测试执行报告
- 提供代码覆盖率统计
- 集成到项目管理工具中

## 常见问题和解决方案

### 1. 测试环境配置问题
- 确保测试环境变量正确设置
- 验证数据库连接配置
- 检查依赖服务是否正常运行

### 2. 异步测试超时
- 增加测试超时时间
- 优化测试代码性能
- 检查是否有未完成的异步操作

### 3. 测试数据污染
- 确保每个测试独立清理数据
- 使用事务回滚机制
- 验证测试前后数据状态

## 后续改进计划

1. **增加测试覆盖率**
   - 补充边缘情况测试
   - 增加错误路径测试
   - 提高现有测试质量

2. **优化测试性能**
   - 并行执行测试
   - 优化数据库初始化
   - 减少测试间依赖

3. **完善测试工具链**
   - 集成更多的测试工具
   - 自动化测试报告生成
   - 改进测试调试体验