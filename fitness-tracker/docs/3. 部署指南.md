# 部署指南

本文档详细说明了如何部署Fitness Tracker应用到生产环境。

## 部署选项

Fitness Tracker支持多种部署方式：

1. **Docker化部署**（推荐）- 使用Docker Compose一键部署
2. **传统部署** - 直接在服务器上部署应用

## Docker化部署（推荐）

### 前提条件
1. 安装Docker Engine 18.06.0+
2. 安装Docker Compose 1.22.0+

### 生产环境部署

```bash
# 1. 克隆或复制项目到服务器
git clone <repository-url>
cd fitness-tracker

# 2. 构建并启动所有服务
docker-compose up -d

# 3. 查看服务状态
docker-compose ps

# 4. 查看日志
docker-compose logs -f

# 5. 停止所有服务
docker-compose down
```

### 开发环境部署

```bash
# 1. 克隆或复制项目到开发机器
git clone <repository-url>
cd fitness-tracker

# 2. 构建并启动开发环境
docker-compose -f docker-compose.dev.yml up -d

# 3. 查看服务状态
docker-compose -f docker-compose.dev.yml ps

# 4. 查看日志
docker-compose -f docker-compose.dev.yml logs -f

# 5. 停止所有服务
docker-compose -f docker-compose.dev.yml down
```

### 环境变量配置

#### MySQL配置
- 用户名: fitnessuser
- 密码: fitnesspass
- 数据库: fitnessTracker

#### 后端环境变量
- NODE_ENV: production/development
- PORT: 3001
- JWT_SECRET: fitnessTrackerSecretKey123
- MYSQL_HOST: mysql
- MYSQL_PORT: 3306
- MYSQL_USER: fitnessuser
- MYSQL_PASSWORD: fitnesspass
- MYSQL_DATABASE: fitnessTracker

## 传统部署

### 前提条件
1. Node.js >= 14.x
2. MySQL 8.0

### 部署步骤

#### 1. 配置MySQL数据库
```sql
-- 创建数据库
CREATE DATABASE fitnessTracker;

-- 创建用户
CREATE USER 'fitnessuser'@'localhost' IDENTIFIED BY 'fitnesspass';

-- 授权
GRANT ALL PRIVILEGES ON fitnessTracker.* TO 'fitnessuser'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 2. 配置后端环境变量
在 `backend/.env` 文件中配置：
```env
NODE_ENV=production
PORT=3001
JWT_SECRET=your_jwt_secret_key

# MySQL Configuration
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=fitnessuser
MYSQL_PASSWORD=fitnesspass
MYSQL_DATABASE=fitnessTracker
```

#### 3. 构建和启动后端服务
```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 构建TypeScript代码
npm run build

# 启动服务
npm start
```

#### 4. 构建和启动前端服务
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 启动服务（可以使用nginx/apache等web服务器提供静态文件服务）
npm run serve
```

## 网络配置

所有服务都在同一个Docker网络中，可以通过服务名称互相访问：
- 前端访问后端API: http://backend:3001
- 后端访问MySQL: mysql://fitnessuser:fitnesspass@mysql:3306/fitnessTracker

## 数据持久化

MySQL数据存储在Docker卷中，即使容器被删除，数据也会保留：
- 生产环境: mysql_data
- 开发环境: mysql_data_dev

## 故障排除

### 常见问题

1. **端口冲突**
   - 修改docker-compose.yml中的ports映射
   - 例如: 将"3000:3000"改为"8080:3000"

2. **构建失败**
   - 确保Dockerfile路径正确
   - 检查package.json中的脚本是否存在

3. **服务无法启动**
   - 查看日志: `docker-compose logs <service-name>`
   - 检查环境变量配置
   - 确保依赖服务已启动

### 日志查看

```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs backend

# 实时查看日志
docker-compose logs -f

# 查看最近的日志
docker-compose logs --tail 100
```

## 自定义配置

### 修改环境变量
1. 编辑docker-compose.yml文件中的environment部分
2. 重新启动服务: `docker-compose up -d`

### 修改端口映射
1. 编辑docker-compose.yml文件中的ports部分
2. 重新启动服务: `docker-compose up -d`

### 添加新服务
1. 在docker-compose.yml中添加新服务定义
2. 运行: `docker-compose up -d`

## 性能优化建议

1. **生产环境优化**
   - 使用多阶段构建减小镜像大小
   - 配置适当的资源限制
   - 使用反向代理（如Nginx）提供静态文件服务

2. **开发环境优化**
   - 使用.dockerignore文件排除不必要的文件
   - 合理配置卷挂载以提高性能
   - 使用缓存机制加速构建过程

## 安全建议

1. **MySQL安全**
   - 更改默认用户名和密码
   - 使用强密码策略
   - 限制网络访问

2. **JWT安全**
   - 使用强密钥
   - 定期更换密钥
   - 设置合理的token过期时间

3. **网络安全**
   - 使用HTTPS
   - 配置防火墙规则
   - 定期更新基础镜像

## 备份与恢复

### 数据备份
```bash
# 备份MySQL数据
docker exec fitness-tracker-mysql mysqldump -u fitnessuser -pfitnesspass fitnessTracker > backup.sql

# 复制备份到主机
docker cp fitness-tracker-mysql:/backup.sql ./backup.sql
```

### 数据恢复
```bash
# 复制备份到容器
docker cp ./backup.sql fitness-tracker-mysql:/backup.sql

# 恢复数据
docker exec fitness-tracker-mysql mysql -u fitnessuser -pfitnesspass fitnessTracker < /backup.sql
```